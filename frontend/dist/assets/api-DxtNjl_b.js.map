{"version":3,"file":"api-DxtNjl_b.js","sources":["../../src/api.ts"],"sourcesContent":["// Унифицированный API-клиент для фронта.\n// Важно: CORS не трогаем (работает на бэке).\n\nimport config from './config';\n\ntype Json = any;\n\nconst apiBase =\n  (config as any)?.api?.v1Base ??\n  (config as any)?.apiBase ??\n  (config as any)?.api?.base ??\n  '/api/v1';\n\nfunction normUrl(path: string) {\n  if (!path.startsWith('/')) path = '/' + path;\n  // если apiBase уже содержит /api/v1 — не дублируем\n  if (apiBase.endsWith('/')) return apiBase.replace(/\\/+$/,'') + path;\n  return apiBase + path;\n}\n\nasync function req<T = Json>(\n  path: string,\n  opts: RequestInit & { auth?: boolean; formData?: boolean } = {}\n): Promise<T> {\n  const url = normUrl(path);\n  const headers: Record<string, string> = { Accept: 'application/json' };\n\n  const token = localStorage.getItem('token');\n  if (opts.auth && token) headers['Authorization'] = `Bearer ${token}`;\n\n  let body: BodyInit | undefined = opts.body as any;\n  if (!opts.formData && body && typeof body === 'object') {\n    headers['Content-Type'] = 'application/json';\n    body = JSON.stringify(body);\n  }\n\n  const res = await fetch(url, {\n    method: opts.method || 'GET',\n    credentials: 'include',\n    headers,\n    body,\n    cache: 'no-store',\n  });\n\n  if (!res.ok) {\n    // Попробуем отдать JSON с ошибкой\n    let err: any = null;\n    try { err = await res.json(); } catch {}\n    const msg = err?.message || `HTTP ${res.status}`;\n    throw new Error(msg);\n  }\n\n  // Пустой ответ\n  if (res.status === 204) return null as T;\n\n  // JSON или пусто\n  const text = await res.text();\n  if (!text) return null as T;\n\n  try {\n    return JSON.parse(text) as T;\n  } catch {\n    // Если не JSON — вернём как есть\n    return (text as unknown) as T;\n  }\n}\n\n/** ====== FEED ====== */\nexport async function feed(params: { limit?: number; offset?: number } = {}) {\n  const q = new URLSearchParams();\n  if (params.limit != null) q.set('limit', String(params.limit));\n  if (params.offset != null) q.set('offset', String(params.offset));\n  const path = `/feed${q.toString() ? `?${q.toString()}` : ''}`;\n  return req(path, { auth: true });\n}\n\nexport async function catchById(id: number | string) {\n  return req(`/catch/${id}`, { auth: true });\n}\n\nexport async function addComment(catchId: number | string, text: string) {\n  return req(`/catch/${catchId}/comments`, {\n    method: 'POST',\n    auth: true,\n    body: { text },\n  });\n}\n\n// Лайк улова\nexport async function likeCatch(catchId: number | string) {\n  return req(`/catch/${catchId}/like`, { method: 'POST', auth: true });\n}\n\n// Рейтинг улова (звёзды и т.п.)\nexport async function rateCatch(catchId: number | string, value: number) {\n  return req(`/catch/${catchId}/rate`, {\n    method: 'POST',\n    auth: true,\n    body: { value },\n  });\n}\n\n// Начисление бонусов (по действию)\nexport async function bonusAward(action: string, payload: Record<string, any> = {}) {\n  return req(`/bonus/award`, {\n    method: 'POST',\n    auth: true,\n    body: { action, ...payload },\n  });\n}\n\n/** ====== MAP / POINTS ====== */\nexport type Bbox = [number, number, number, number];\n\nexport async function points(params: { limit?: number; bbox?: Bbox; filter?: string } = {}) {\n  const q = new URLSearchParams();\n  if (params.limit != null) q.set('limit', String(params.limit));\n  if (params.filter) q.set('filter', params.filter);\n  if (params.bbox) q.set('bbox', params.bbox.join(','));\n  const path = `/map/points${q.toString() ? `?${q.toString()}` : ''}`;\n  return req(path, { auth: true });\n}\n\nexport async function addPlace(body: {\n  name: string;\n  lat: number;\n  lng: number;\n  description?: string;\n  photos?: string[];\n  privacy?: 'all' | 'friends' | 'me';\n}) {\n  return req(`/points`, { method: 'POST', auth: true, body });\n}\n\nexport async function placeById(id: number | string) {\n  return req(`/points/${id}`, { auth: true });\n}\n\n/** ====== ADD CATCH ====== */\nexport async function addCatch(body: {\n  lat: number;\n  lng: number;\n  species?: string;\n  length?: number;\n  weight?: number;\n  style?: string;\n  lure?: string;\n  tackle?: string;\n  notes?: string;\n  photo_url?: string;\n  caught_at?: string; // ISO 8601\n  privacy?: 'all' | 'friends' | 'me';\n}) {\n  return req(`/catch`, { method: 'POST', auth: true, body });\n}\n\n/** ====== WEATHER FAVS ====== */\nexport async function getWeatherFavs() {\n  return req(`/weather/favs`, { auth: true });\n}\n\nexport async function saveWeatherFav(p: { lat: number; lng: number; name?: string }) {\n  return req(`/weather/favs`, { method: 'POST', auth: true, body: p });\n}\n\n/** ====== PROFILE / NOTIFICATIONS ====== */\nexport async function profileMe() {\n  return req(`/profile/me`, { auth: true });\n}\n\nexport async function notifications() {\n  return req(`/notifications`, { auth: true });\n}\n\n/** ====== AUTH ====== */\nexport async function authLogin(email: string, password: string) {\n  const r = await req<{ token?: string; user?: any }>(`/auth/login`, {\n    method: 'POST',\n    body: { email, password },\n  });\n  if (r?.token) localStorage.setItem('token', r.token);\n  return r;\n}\n\nexport async function authRegister(payload: {\n  email: string;\n  password: string;\n  name?: string;\n  login?: string;\n  agree_personal_data: boolean;\n  agree_terms: boolean;\n}) {\n  const r = await req<{ token?: string; user?: any }>(`/auth/register`, {\n    method: 'POST',\n    body: payload,\n  });\n  if (r?.token) localStorage.setItem('token', r.token);\n  return r;\n}\n\nexport async function authLogout() {\n  try { await req(`/auth/logout`, { method: 'POST', auth: true }); } catch {}\n  localStorage.removeItem('token');\n  return { ok: true };\n}\n\n/** ====== BANNERS (опционально, для централизованного вызова) ====== */\nexport async function bannersGet(slot: string, limit = 1) {\n  const q = new URLSearchParams({ slot, limit: String(limit) });\n  return req(`/banners?${q.toString()}`, { auth: false });\n}\n\nexport function isAuthed(): boolean {\n  try { return !!localStorage.getItem('token'); } catch { return false }\n}\n\nexport default {\n  // feed\n  feed,\n  catchById,\n  addComment,\n  likeCatch,\n  rateCatch,\n  bonusAward,\n  addCatch,\n  // map/points\n  points,\n  addPlace,\n  placeById,\n  // weather\n  getWeatherFavs,\n  saveWeatherFav,\n  // profile / notifications\n  profileMe,\n  notifications,\n  // auth\n  authLogin,\n  authRegister,\n  authLogout,\n    isAuthed,\n  // banners\n  bannersGet,\n};\n/**\n * Завершение сессии пользователя.\n * Отправляем POST /auth/logout (мягко), игнорируем сетевые ошибки,\n * затем чистим localStorage и возвращаем {ok:true}.\n * Требует, чтобы в файле выше был определён `const base = config.apiBase`.\n */\nexport async function logout(): Promise<{ok: boolean}> {\n  const token = typeof localStorage !== 'undefined' ? localStorage.getItem('token') : null;\n  try {\n    // Мягкий вызов backend — если роут отключён/вернёт ошибку, просто игнорируем\n    await fetch(`${base}/auth/logout`, {\n      method: 'POST',\n      headers: {\n        'Accept': 'application/json',\n        'Content-Type': 'application/json',\n        ...(token ? { 'Authorization': `Bearer ${token}` } : {}),\n      },\n      credentials: 'include',\n    });\n  } catch (_e) {\n    // ignore\n  }\n  try {\n    if (typeof localStorage !== 'undefined') {\n      localStorage.removeItem('token');\n    }\n  } catch (_e) {\n    // ignore\n  }\n  return { ok: true };\n}\n\n// --- auto-added: addCatchComment ---\n/**\n * Добавить комментарий к улову\n * POST /catch/{id}/comments\n * Бек ожидает JSON с текстом комментария. Чаще всего поле называется \"text\".\n */\nexport async function addCatchComment(\n  catchId: number | string,\n  text: string\n): Promise<any> {\n  const url = `${base}/catch/${catchId}/comments`;\n  const token = (typeof localStorage !== 'undefined') ? localStorage.getItem('token') : null;\n\n  const res = await fetch(url, {\n    method: 'POST',\n    headers: {\n      'Accept': 'application/json',\n      'Content-Type': 'application/json',\n      ...(token ? { 'Authorization': `Bearer ${token}` } : {}),\n    },\n    credentials: 'include',\n    body: JSON.stringify({ text }),\n  });\n\n  // Если валидация на беке требует другое имя поля (например, \"message\"),\n  // можно попробовать повторить с fallback:\n  if (res.status === 422) {\n    // попробуем \"message\" вместо \"text\"\n    const retry = await fetch(url, {\n      method: 'POST',\n      headers: {\n        'Accept': 'application/json',\n        'Content-Type': 'application/json',\n        ...(token ? { 'Authorization': `Bearer ${token}` } : {}),\n      },\n      credentials: 'include',\n      body: JSON.stringify({ message: text }),\n    });\n    if (!retry.ok) {\n      const t = await retry.text().catch(() => '');\n      throw new Error(`addCatchComment failed: ${retry.status} ${retry.statusText} ${t}`);\n    }\n    try { return await retry.json(); } catch { return { ok: true }; }\n  }\n\n  if (!res.ok) {\n    const t = await res.text().catch(() => '');\n    throw new Error(`addCatchComment failed: ${res.status} ${res.statusText} ${t}`);\n  }\n  try { return await res.json(); } catch { return { ok: true }; }\n}\n// --- /auto-added: addCatchComment ---\n"],"names":["apiBase","config","normUrl","path","req","opts","url","headers","token","body","res","err","msg","text","feed","params","q","catchById","id","likeCatch","catchId","rateCatch","value","bonusAward","action","payload","points","addPlace","placeById","addCatch","getWeatherFavs","saveWeatherFav","p","profileMe","isAuthed","logout","addCatchComment","retry","t"],"mappings":"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"}