{"version":3,"file":"FeedScreen-DrdqpNdq.js","sources":["../../src/components/RatingStars.tsx","../../src/components/BannerSlot.tsx","../../src/components/Toast.tsx","../../src/pages/FeedScreen.tsx"],"sourcesContent":["import React, { useState } from 'react';\nimport Icon from './Icon';\n\nconst clamp = (n:number, a=1, b=5)=> Math.max(a, Math.min(b, n));\n\nconst RatingStars: React.FC<{\n  value?: number;\n  onChange?: (v:number)=>void;\n  size?: number;\n}> = ({value=0, onChange, size=22}) => {\n  const [hover, setHover] = useState<number|null>(null);\n  const v = clamp(Math.round(hover ?? value), 0, 5);\n  return (\n    <div className=\"row\" role=\"radiogroup\" aria-label=\"Оценка\">\n      {[1,2,3,4,5].map(i=>(\n        <button\n          key={i}\n          type=\"button\"\n          className=\"btn\"\n          style={{padding:'6px 8px'}}\n          aria-checked={v>=i}\n          role=\"radio\"\n          onMouseEnter={()=>setHover(i)}\n          onMouseLeave={()=>setHover(null)}\n          onClick={()=> onChange?.(i)}\n          title={`${i} из 5`}\n        >\n          <Icon name={v>=i? 'star':'star_rate'} size={size} />\n        </button>\n      ))}\n    </div>\n  );\n};\nexport default RatingStars;\n","import React, { useEffect, useState } from 'react';\nimport config from '../config';\nimport Icon from './Icon';\n\ntype Banner = {\n  id: number | string;\n  image_url?: string;\n  link_url?: string;\n  title?: string;\n};\n\ntype Props = {\n  slot: string;           // идентификатор баннерного места\n  className?: string;\n  limit?: number;         // сколько баннеров показывать (по умолчанию 1)\n};\n\nconst BannerSlot: React.FC<Props> = ({ slot, className, limit = 1 }) => {\n  const [banners, setBanners] = useState<Banner[] | null>(null);\n  const [err, setErr] = useState<string | null>(null);\n\n  useEffect(() => {\n    let aborted = false;\n\n    async function load() {\n      try {\n        setErr(null);\n        // Берём базу из конфига. Если в конфиге есть api.v1Base — используем его, иначе api.base\n        const apiBase =\n          (config as any)?.api?.v1Base ??\n          (config as any)?.apiBase ??\n          (config as any)?.api?.base ??\n          '';\n\n        // Прямой запрос без зависимости от src/api.ts\n        const url = `${apiBase}/banners?slot=${encodeURIComponent(slot)}&limit=${encodeURIComponent(\n          String(limit)\n        )}`;\n\n        const res = await fetch(url, {\n          method: 'GET',\n          credentials: 'include',\n          headers: {\n            'Accept': 'application/json'\n          }\n        });\n\n        if (!res.ok) {\n          throw new Error(`HTTP ${res.status}`);\n        }\n\n        const data = await res.json().catch(() => ({}));\n        // Поддержим оба формата: {items:[...]} или сразу [...]\n        const items: Banner[] = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []);\n\n        if (!aborted) {\n          setBanners(items);\n        }\n      } catch (e: any) {\n        if (!aborted) {\n          setErr(e?.message || 'Failed to load banners');\n          setBanners([]);\n        }\n      }\n    }\n\n    load();\n\n    return () => {\n      aborted = true;\n    };\n  }, [slot, limit]);\n\n  const fallbackImg =\n    (config as any)?.banners?.fallbackImage ||\n    (config as any)?.images?.bannerFallback ||\n    '';\n\n  if (err) {\n    return (\n      <div className={`glass rounded-xl p-3 ${className || ''}`}>\n        <div className=\"flex items-center gap-2 text-red-500\">\n          <Icon name=\"error\" />\n          <span>Ошибка загрузки баннеров: {err}</span>\n        </div>\n      </div>\n    );\n  }\n\n  if (!banners) {\n    return (\n      <div className={`glass rounded-xl p-3 ${className || ''}`}>\n        <div className=\"flex items-center gap-2 opacity-70\">\n          <Icon name=\"hourglass_top\" />\n          <span>Загрузка…</span>\n        </div>\n      </div>\n    );\n  }\n\n  if (banners.length === 0) {\n    // Пусто — покажем заглушку, чтобы слот не “прыгнул”\n    return (\n      <div className={`glass rounded-xl p-3 ${className || ''}`}>\n        <div className=\"flex items-center gap-2 opacity-60\">\n          <Icon name=\"image\" />\n          <span>Баннеров нет</span>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className={`w-full ${className || ''}`}>\n      {banners.slice(0, limit).map((b) => {\n        const img = b.image_url || fallbackImg;\n        const content = (\n          <div\n            className=\"glass rounded-2xl overflow-hidden border border-white/10\"\n            style={{\n              backdropFilter: 'blur(12px)'\n            }}\n          >\n            {img ? (\n              <img\n                src={img}\n                alt={b.title || 'banner'}\n                className=\"w-full h-auto block\"\n                loading=\"lazy\"\n              />\n            ) : (\n              <div className=\"p-4 flex items-center gap-2\">\n                <Icon name=\"image\" />\n                <span>{b.title || 'Рекламный баннер'}</span>\n              </div>\n            )}\n          </div>\n        );\n\n        return (\n          <div key={String(b.id)} className=\"mb-3 last:mb-0\">\n            {b.link_url ? (\n              <a href={b.link_url} target=\"_blank\" rel=\"noopener noreferrer\">\n                {content}\n              </a>\n            ) : (\n              content\n            )}\n          </div>\n        );\n      })}\n    </div>\n  );\n};\n\nexport default BannerSlot;\n","import React from 'react';\nlet subs: ((msg:string)=>void)[] = [];\nexport function pushToast(msg:string){ subs.forEach(fn=>fn(msg)); }\n\nconst ToastHost: React.FC = () => {\n  const [queue,setQueue] = React.useState<string[]>([]);\n  React.useEffect(()=> {\n    const fn = (m:string)=> setQueue(q=>[...q,m].slice(-3));\n    subs.push(fn);\n    return ()=> { subs = subs.filter(s=>s!==fn); };\n  }, []);\n  React.useEffect(()=> {\n    if(!queue.length) return;\n    const t = setTimeout(()=> setQueue(q=>q.slice(1)), 2800);\n    return ()=> clearTimeout(t);\n  }, [queue]);\n  return (\n    <div style={{position:'fixed', bottom:16, left:16, zIndex:9999, display:'grid', gap:8}}>\n      {queue.map((m,i)=>(\n        <div key={i} className=\"glass card\" style={{padding:'10px 12px', backdropFilter:'blur(8px)'}}>\n          {m}\n        </div>\n      ))}\n    </div>\n  );\n};\nexport default ToastHost;\n","import React, { useEffect, useState } from 'react';\nimport { feed, likeCatch, rateCatch, bonusAward } from '../api';\nimport Icon from '../components/Icon';\nimport config from '../config';\nimport { Link } from 'react-router-dom';\nimport RatingStars from '../components/RatingStars';\nimport BannerSlot from '../components/BannerSlot';\nimport { pushToast } from '../components/Toast';\n\nconst FeedScreen: React.FC = () => {\n  const [items, setItems] = useState<any[]>([]);\n  const [err, setErr] = useState('');\n\n  useEffect(()=>{\n    feed({limit:20, offset:0})\n      .then((r)=> Array.isArray(r)? setItems(r) : setItems([]))\n      .catch((e)=> setErr(e.message||'Ошибка загрузки ленты'));\n  },[]);\n\n  async function onLike(id:any){\n    try{\n      await likeCatch(id);\n      pushToast('Лайк засчитан');\n      // Попытка начислить бонус (если бэк поддерживает)\n      bonusAward('like', {catch_id:id}).catch(()=>{});\n    }catch(e:any){ pushToast(e?.message||'Ошибка'); }\n  }\n  async function onRate(id:any, stars:number){\n    try{\n      await rateCatch(id, stars);\n      pushToast(`Оценка ${stars}/5 сохранена`);\n      bonusAward('like', {kind:'rate', catch_id:id, stars}).catch(()=>{});\n    }catch(e:any){ pushToast(e?.message||'Ошибка'); }\n  }\n\n  const spaced = [];\n  const every = config.banners.feedEvery;\n  for (let i=0;i<items.length;i++){\n    spaced.push({kind:'post', data:items[i]});\n    if ((i+1) % every === 0) spaced.push({kind:'banner', slot:`feed_${(i+1)/every}`});\n  }\n\n  return (\n    <div className=\"container\">\n      <h2 className=\"h2\">Лента</h2>\n      {err && <div className=\"card glass\" style={{color:'#ffb4b4'}}>{err}</div>}\n\n      {(spaced.length? spaced : items.map(x=>({kind:'post', data:x}))).map((row:any, idx:number)=>{\n        if (row.kind==='banner') return <BannerSlot key={`b-${idx}`} slot={row.slot} />;\n        const it = row.data;\n        return (\n          <div key={it.id ?? idx} className=\"glass card\">\n            <div className=\"row\" style={{justifyContent:'space-between'}}>\n              <div className=\"row\">\n                <strong>{it.user_name || 'рыбак'}</strong>\n                <span className=\"muted\">· {new Date(it.created_at||Date.now()).toLocaleString()}</span>\n              </div>\n              <div className=\"row\">\n                <button className=\"btn\" onClick={()=>onLike(it.id)}><Icon name={config.icons.like} /> {it.likes_count ?? 0}</button>\n                <Link className=\"btn\" to={`/catch/${it.id}`}><Icon name={config.icons.comment} /> {it.comments_count ?? 0}</Link>\n                <button className=\"btn\"><Icon name={config.icons.share} /> Поделиться</button>\n              </div>\n            </div>\n\n            {it.media_url && <img src={it.media_url} alt=\"\" style={{width:'100%', borderRadius:12, marginTop:8}} />}\n            {it.caption && <div style={{marginTop:8}}>{it.caption}</div>}\n\n            <div className=\"row\" style={{marginTop:8, justifyContent:'space-between', alignItems:'center'}}>\n              <div className=\"muted\">Оцените улов</div>\n              <RatingStars value={Math.round(it.rating_avg || 0)} onChange={(v)=>onRate(it.id, v)} />\n            </div>\n          </div>\n        );\n      })}\n    </div>\n  );\n};\nexport default FeedScreen;\n"],"names":["clamp","n","a","b","RatingStars","value","onChange","size","hover","setHover","useState","v","i","jsx","Icon","BannerSlot","slot","className","limit","banners","setBanners","err","setErr","useEffect","aborted","load","url","config","res","data","items","e","fallbackImg","jsxs","img","content","subs","pushToast","msg","fn","FeedScreen","setItems","feed","r","onLike","id","likeCatch","bonusAward","onRate","stars","rateCatch","spaced","every","x","row","idx","it","Link"],"mappings":"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"}