{"version":3,"file":"MapScreen-BLwvkYYZ.js","sources":["../../src/pages/MapScreen.tsx"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport config, { featureFlags } from '../config';\nimport { points, saveWeatherFav, isAuthed } from '../api';\nimport Icon from '../components/Icon';\n\n// простая загрузка Leaflet (CDN), чтобы карта всегда рисовалась\nfunction useLeaflet() {\n  const [ready, setReady] = useState<boolean>(!!(window as any).L);\n\n  useEffect(() => {\n    if ((window as any).L) { setReady(true); return; }\n\n    const linkId = 'leaflet-css-cdn';\n    if (!document.getElementById(linkId)) {\n      const link = document.createElement('link');\n      link.id = linkId;\n      link.rel = 'stylesheet';\n      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';\n      link.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';\n      link.crossOrigin = '';\n      document.head.appendChild(link);\n    }\n\n    const scriptId = 'leaflet-js-cdn';\n    if (!document.getElementById(scriptId)) {\n      const s = document.createElement('script');\n      s.id = scriptId;\n      s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';\n      s.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';\n      s.crossOrigin = '';\n      s.onload = () => setReady(true);\n      document.body.appendChild(s);\n    } else {\n      setReady(true);\n    }\n  }, []);\n\n  return ready;\n}\n\ntype Pt = { id: number|string; lat: number; lng: number; title?: string; thumbnail?: string; type?: string; };\n\nexport default function MapScreen() {\n  const navigate = useNavigate();\n  const mapRef = useRef<HTMLDivElement | null>(null);\n  const leafletReady = useLeaflet();\n  const REQUIRE_AUTH_WEATHER = (featureFlags?.requireAuthForWeatherSave ?? false);\n\n  useEffect(() => {\n    if (!leafletReady || !mapRef.current) return;\n    const L = (window as any).L;\n    if (!L) return;\n\n    // инициализация карты\n    const map = L.map(mapRef.current).setView([55.751244, 37.618423], 9);\n    const tileUrl = (config as any)?.map?.tiles ??\n      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';\n    L.tileLayer(tileUrl, { maxZoom: 19 }).addTo(map);\n\n    // Загрузка точек\n    (async () => {\n      try {\n        const raw = await points({ limit: 500 });\n        const arr: Pt[] = Array.isArray(raw) ? raw : (Array.isArray((raw as any)?.items) ? (raw as any).items : []);\n        arr.forEach((p) => {\n          if (typeof p?.lat !== 'number' || typeof p?.lng !== 'number') return;\n          const m = L.marker([p.lat, p.lng]).addTo(map);\n          const inner = `\n            <div style=\"display:flex;gap:8px;align-items:center\">\n              ${p.thumbnail ? `<img src=\"${p.thumbnail}\" style=\"width:56px;height:56px;object-fit:cover;border-radius:8px\" />` : ''}\n              <div>\n                <div style=\"font-weight:600\">${p.title ?? 'Точка'}</div>\n                <button data-id=\"${p.id}\" class=\"go-detail\" style=\"margin-top:6px;padding:6px 10px;border-radius:8px;background:#0ea5e9;color:#fff;border:0;cursor:pointer\">Открыть</button>\n              </div>\n            </div>\n          `;\n          m.bindPopup(inner);\n\n          m.on('popupopen', (e: any) => {\n            const el = e.popup.getElement() as HTMLElement;\n            const btn = el.querySelector('.go-detail') as HTMLButtonElement | null;\n            if (btn) {\n              btn.onclick = () => {\n                if (p.type === 'catch') {\n                  navigate(`/catch/${p.id}`);\n                } else {\n                  navigate(`/place/${p.id}`);\n                }\n              };\n            }\n          });\n        });\n      } catch (e) {\n        console.error('points load error', e);\n      }\n    })();\n\n    // Клик по карте → предложение сохранить точку для погоды\n    map.on('click', async (ev: any) => {\n      const { lat, lng } = ev.latlng || {};\n      if (typeof lat !== 'number' || typeof lng !== 'number') return;\n\n      if (REQUIRE_AUTH_WEATHER && !(await isAuthed())) {\n        const go = confirm('Сохранение точки доступно только авторизованным пользователям. Войти сейчас?');\n        if (go) navigate('/login');\n        return;\n      }\n\n      const doSave = confirm('Сохранить эту точку для страницы погоды?');\n      if (!doSave) return;\n\n      const name = prompt('Название точки', 'Моя точка');\n      try {\n        await saveWeatherFav({ lat, lng, name: name || 'Моя точка' });\n        alert('Точка сохранена. Проверьте на странице Погоды.');\n      } catch (e) {\n        console.error('saveWeatherFav error', e);\n        alert('Не удалось сохранить точку');\n      }\n    });\n\n    return () => map.remove();\n  }, [leafletReady]);\n\n  // Глассморфизм контейнер\n  return (\n    <div style={{\n      position:'relative',\n      width:'100%',\n      height:'calc(100dvh - 116px)' // хедер+меню\n    }}>\n      <div ref={mapRef} style={{width:'100%',height:'100%'}} />\n      <div style={{\n        position:'absolute', top:12, right:12,\n        backdropFilter:'blur(10px)',\n        background:'rgba(255,255,255,0.3)',\n        border:'1px solid rgba(255,255,255,0.4)',\n        borderRadius:16, padding:'8px 10px', display:'flex', gap:8\n      }}>\n        <Icon name=\"my_location\" />\n        <span style={{fontWeight:600}}>Карта</span>\n      </div>\n    </div>\n  );\n}\n"],"names":["useLeaflet","ready","setReady","useState","useEffect","linkId","link","scriptId","s","MapScreen","navigate","useNavigate","mapRef","useRef","leafletReady","L","map","tileUrl","config","raw","points","p","m","inner","e","btn","ev","lat","lng","isAuthed","name","saveWeatherFav","jsxs","jsx","Icon"],"mappings":"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"}