import{r as u,j as e,I as o,c as i,L as y}from"./index-Cex0JMuM.js";import{f as k,l as N,b,r as w}from"./api-DpD81C9e.js";const _=(c,t=1,l=5)=>Math.max(t,Math.min(l,c)),$=({value:c=0,onChange:t,size:l=22})=>{const[d,m]=u.useState(null),h=_(Math.round(d??c),0,5);return e.jsx("div",{className:"row",role:"radiogroup","aria-label":"Оценка",children:[1,2,3,4,5].map(n=>e.jsx("button",{type:"button",className:"btn",style:{padding:"6px 8px"},"aria-checked":h>=n,role:"radio",onMouseEnter:()=>m(n),onMouseLeave:()=>m(null),onClick:()=>t?.(n),title:`${n} из 5`,children:e.jsx(o,{name:h>=n?"star":"star_rate",size:l})},n))})},E=({slot:c,className:t,limit:l=1})=>{const[d,m]=u.useState(null),[h,n]=u.useState(null);u.useEffect(()=>{let s=!1;async function r(){try{n(null);const f=`${i?.api?.v1Base??i?.apiBase??i?.api?.base??""}/banners?slot=${encodeURIComponent(c)}&limit=${encodeURIComponent(String(l))}`,g=await fetch(f,{method:"GET",credentials:"include",headers:{Accept:"application/json"}});if(!g.ok)throw new Error(`HTTP ${g.status}`);const p=await g.json().catch(()=>({})),v=Array.isArray(p)?p:Array.isArray(p?.items)?p.items:[];s||m(v)}catch(a){s||(n(a?.message||"Failed to load banners"),m([]))}}return r(),()=>{s=!0}},[c,l]);const x=i?.banners?.fallbackImage||i?.images?.bannerFallback||"";return h?e.jsx("div",{className:`glass rounded-xl p-3 ${t||""}`,children:e.jsxs("div",{className:"flex items-center gap-2 text-red-500",children:[e.jsx(o,{name:"error"}),e.jsxs("span",{children:["Ошибка загрузки баннеров: ",h]})]})}):d?d.length===0?e.jsx("div",{className:`glass rounded-xl p-3 ${t||""}`,children:e.jsxs("div",{className:"flex items-center gap-2 opacity-60",children:[e.jsx(o,{name:"image"}),e.jsx("span",{children:"Баннеров нет"})]})}):e.jsx("div",{className:`w-full ${t||""}`,children:d.slice(0,l).map(s=>{const r=s.image_url||x,a=e.jsx("div",{className:"glass rounded-2xl overflow-hidden border border-white/10",style:{backdropFilter:"blur(12px)"},children:r?e.jsx("img",{src:r,alt:s.title||"banner",className:"w-full h-auto block",loading:"lazy"}):e.jsxs("div",{className:"p-4 flex items-center gap-2",children:[e.jsx(o,{name:"image"}),e.jsx("span",{children:s.title||"Рекламный баннер"})]})});return e.jsx("div",{className:"mb-3 last:mb-0",children:s.link_url?e.jsx("a",{href:s.link_url,target:"_blank",rel:"noopener noreferrer",children:a}):a},String(s.id))})}):e.jsx("div",{className:`glass rounded-xl p-3 ${t||""}`,children:e.jsxs("div",{className:"flex items-center gap-2 opacity-70",children:[e.jsx(o,{name:"hourglass_top"}),e.jsx("span",{children:"Загрузка…"})]})})};let S=[];function j(c){S.forEach(t=>t(c))}const I=()=>{const[c,t]=u.useState([]),[l,d]=u.useState("");u.useEffect(()=>{k({limit:20,offset:0}).then(s=>Array.isArray(s)?t(s):t([])).catch(s=>d(s.message||"Ошибка загрузки ленты"))},[]);async function m(s){try{await N(s),j("Лайк засчитан"),b("like",{catch_id:s}).catch(()=>{})}catch(r){j(r?.message||"Ошибка")}}async function h(s,r){try{await w(s,r),j(`Оценка ${r}/5 сохранена`),b("like",{kind:"rate",catch_id:s,stars:r}).catch(()=>{})}catch(a){j(a?.message||"Ошибка")}}const n=[],x=i.banners.feedEvery;for(let s=0;s<c.length;s++)n.push({kind:"post",data:c[s]}),(s+1)%x===0&&n.push({kind:"banner",slot:`feed_${(s+1)/x}`});return e.jsxs("div",{className:"container",children:[e.jsx("h2",{className:"h2",children:"Лента"}),l&&e.jsx("div",{className:"card glass",style:{color:"#ffb4b4"},children:l}),(n.length?n:c.map(s=>({kind:"post",data:s}))).map((s,r)=>{if(s.kind==="banner")return e.jsx(E,{slot:s.slot},`b-${r}`);const a=s.data;return e.jsxs("div",{className:"glass card",children:[e.jsxs("div",{className:"row",style:{justifyContent:"space-between"},children:[e.jsxs("div",{className:"row",children:[e.jsx("strong",{children:a.user_name||"рыбак"}),e.jsxs("span",{className:"muted",children:["· ",new Date(a.created_at||Date.now()).toLocaleString()]})]}),e.jsxs("div",{className:"row",children:[e.jsxs("button",{className:"btn",onClick:()=>m(a.id),children:[e.jsx(o,{name:i.icons.like})," ",a.likes_count??0]}),e.jsxs(y,{className:"btn",to:`/catch/${a.id}`,children:[e.jsx(o,{name:i.icons.comment})," ",a.comments_count??0]}),e.jsxs("button",{className:"btn",children:[e.jsx(o,{name:i.icons.share})," Поделиться"]})]})]}),a.media_url&&e.jsx("img",{src:a.media_url,alt:"",style:{width:"100%",borderRadius:12,marginTop:8}}),a.caption&&e.jsx("div",{style:{marginTop:8},children:a.caption}),e.jsxs("div",{className:"row",style:{marginTop:8,justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{className:"muted",children:"Оцените улов"}),e.jsx($,{value:Math.round(a.rating_avg||0),onChange:f=>h(a.id,f)})]})]},a.id??r)})]})};export{I as default};
//# sourceMappingURL=FeedScreen-DrdqpNdq.js.map
